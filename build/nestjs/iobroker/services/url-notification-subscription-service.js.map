{
  "version": 3,
  "sources": ["../../../../src/nestjs/iobroker/services/url-notification-subscription-service.ts"],
  "sourcesContent": ["import { HttpService } from '@nestjs/axios';\nimport { BadRequestException, GatewayTimeoutException, Injectable, InternalServerErrorException } from '@nestjs/common';\nimport { IsArray, IsNotEmpty, IsNumber, IsOptional, IsString } from 'class-validator';\nimport { AdapterStr, DEFAULT_TIMEOUT } from '../../main';\nimport { Result } from '../interfaces/result.interface';\n\nconst _URL_SUBSCRIPTION: Record<string, string[]> = {};\nconst httpService = new HttpService();\n\nexport class AddURLNotification_DTO {\n    @IsNotEmpty()\n    @IsString()\n    stateID!: string;\n\n    @IsNotEmpty()\n    @IsArray()\n    urls!: string[];\n\n    @IsOptional()\n    @IsNumber()\n    timeout!: number;\n}\n\nexport const listen = async (\n    id: string,\n    state: ioBroker.State | null | undefined,\n    operation: 'change' | 'deletion',\n): Promise<void> => {\n    if (operation === 'deletion') {\n    } else {\n        if (_URL_SUBSCRIPTION.hasOwnProperty(id)) {\n            for (const url of _URL_SUBSCRIPTION[id]) {\n                try {\n                    await httpService.axiosRef.post(url, { id: id, state: state });\n                } catch (error) {\n                    AdapterStr.adapter?.log.error(`${error} - url: ${url}`);\n                }\n            }\n        }\n    }\n};\n\nexport const UrlNotificationSubscriptionServiceListener = {\n    listen: listen,\n};\n\n@Injectable()\nexport class URLNotificationSubscriptionService {\n    public addURLNotificationSubscription = async ({\n        stateID,\n        urls,\n        timeout = DEFAULT_TIMEOUT,\n    }: AddURLNotification_DTO): Promise<Result> => {\n        AdapterStr.adapter?.log.silly('URLNotificationSubscriptionService');\n\n        const adapter = AdapterStr.adapter;\n        if (!adapter) throw new InternalServerErrorException('ioBroker adapter not set ??');\n\n        // check if stateID is availavle\n        const a = await adapter.getForeignStateAsync(stateID);\n        if (!a) throw new BadRequestException(`the stateID: ${stateID} was not found on ioBroker`);\n\n        for (const url of urls) {\n            if (!_URL_SUBSCRIPTION.hasOwnProperty(stateID)) {\n                _URL_SUBSCRIPTION[stateID] = [];\n                const resultPromise = adapter.subscribeForeignStatesAsync(stateID);\n                const timeoutPromise = new Promise((resolve) => {\n                    setTimeout(resolve, timeout, { errorTM: '' });\n                });\n                const result1: any = await Promise.race([resultPromise, timeoutPromise]);\n                if (result1.hasOwnProperty('error')) {\n                    throw new InternalServerErrorException(`Error while subscribe to ${stateID}`);\n                }\n                if (result1.hasOwnProperty('errorTM')) {\n                    throw new GatewayTimeoutException(`TimeoutError on miio test after ${timeout}ms`);\n                }\n            }\n            if (_URL_SUBSCRIPTION.hasOwnProperty(stateID) && !_URL_SUBSCRIPTION[stateID].includes(url)) {\n                _URL_SUBSCRIPTION[stateID].push(url);\n            }\n        }\n        return { result: 'all ok' };\n    };\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAA4B;AAC5B,oBAAuG;AACvG,6BAAoE;AACpE,kBAA4C;AAG5C,MAAM,oBAA8C,CAAC;AACrD,MAAM,cAAc,IAAI,yBAAY;AAE7B,MAAM,uBAAuB;AAYpC;AATI;AAAA,EAFA,AAAC,uCAAW;AAAA,EACZ,AAAC,qCAAS;AAAA,GACV,AAHS,uBAGT;AAIA;AAAA,EAFA,AAAC,uCAAW;AAAA,EACZ,AAAC,oCAAQ;AAAA,GACT,AAPS,uBAOT;AAIA;AAAA,EAFA,AAAC,uCAAW;AAAA,EACZ,AAAC,qCAAS;AAAA,GACV,AAXS,uBAWT;AAGG,MAAM,SAAS,OAClB,IACA,OACA,cACgB;AA3BpB;AA4BI,MAAI,cAAc,YAAY;AAAA,EAC9B,OAAO;AACH,QAAI,kBAAkB,eAAe,EAAE,GAAG;AACtC,iBAAW,OAAO,kBAAkB,KAAK;AACrC,YAAI;AACA,gBAAM,YAAY,SAAS,KAAK,KAAK,EAAE,IAAQ,MAAa,CAAC;AAAA,QACjE,SAAS,OAAP;AACE,uCAAW,YAAX,mBAAoB,IAAI,MAAM,GAAG,gBAAgB;AAAA,QACrD;AAAA,MACJ;AAAA,IACJ;AAAA,EACJ;AACJ;AAEO,MAAM,6CAA6C;AAAA,EACtD;AACJ;AAGO,IAAM,qCAAN,MAAyC;AAAA,EAAzC;AACH,SAAO,iCAAiC,OAAO;AAAA,MAC3C;AAAA,MACA;AAAA,MACA,UAAU;AAAA,UACiC;AApDnD;AAqDQ,mCAAW,YAAX,mBAAoB,IAAI,MAAM;AAE9B,YAAM,UAAU,uBAAW;AAC3B,UAAI,CAAC;AAAS,cAAM,IAAI,2CAA6B,6BAA6B;AAGlF,YAAM,IAAI,MAAM,QAAQ,qBAAqB,OAAO;AACpD,UAAI,CAAC;AAAG,cAAM,IAAI,kCAAoB,gBAAgB,mCAAmC;AAEzF,iBAAW,OAAO,MAAM;AACpB,YAAI,CAAC,kBAAkB,eAAe,OAAO,GAAG;AAC5C,4BAAkB,WAAW,CAAC;AAC9B,gBAAM,gBAAgB,QAAQ,4BAA4B,OAAO;AACjE,gBAAM,iBAAiB,IAAI,QAAQ,CAAC,YAAY;AAC5C,uBAAW,SAAS,SAAS,EAAE,SAAS,GAAG,CAAC;AAAA,UAChD,CAAC;AACD,gBAAM,UAAe,MAAM,QAAQ,KAAK,CAAC,eAAe,cAAc,CAAC;AACvE,cAAI,QAAQ,eAAe,OAAO,GAAG;AACjC,kBAAM,IAAI,2CAA6B,4BAA4B,SAAS;AAAA,UAChF;AACA,cAAI,QAAQ,eAAe,SAAS,GAAG;AACnC,kBAAM,IAAI,sCAAwB,mCAAmC,WAAW;AAAA,UACpF;AAAA,QACJ;AACA,YAAI,kBAAkB,eAAe,OAAO,KAAK,CAAC,kBAAkB,SAAS,SAAS,GAAG,GAAG;AACxF,4BAAkB,SAAS,KAAK,GAAG;AAAA,QACvC;AAAA,MACJ;AACA,aAAO,EAAE,QAAQ,SAAS;AAAA,IAC9B;AAAA;AACJ;AApCa,qCAAN;AAAA,EADP,AAAC,8BAAW;AAAA,GACC;",
  "names": []
}
